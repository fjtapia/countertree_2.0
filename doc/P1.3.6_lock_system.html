<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta content="application/xhtml+xml; charset=UTF-8" http-equiv="content-type" />
    <meta content="HTML Tidy for Windows (vers 1st November 2003), see www.w3.org"
      name="generator" />
    <title>Boost C++ Libraries</title>
    <link type="image/ico" href="img/favicon.ico" rel="icon" />
    <link href="css/section-welcome.css" type="text/css" rel="stylesheet" />
    <link href="css/code.css" type="text/css" rel="stylesheet" />
    <!--[if IE 7]> <style type="text/css"> body { behavior: url(/style-v2/csshover3.htc); } </style> <![endif]-->
    <meta content="mpr2HgFpodnbF_8fv4qXd9roIClVwtX3C-Kd3F6r61w" name="google-site-verification" />
    <!--
Note: Editing website content is documented at:http://www.boost.org/development/website_updating.html-->
  </head>
  <body>
    <div id="heading">
      <div class="heading-inner">
        <h1 class="heading-title"> <a href="http://www.boost.org/"> <img class="heading-logo"
              alt="Boost C++ Libraries" src="img/space.png" /> <span class="heading-boost">Boost</span>
            <span class="heading-cpplibraries">C++ Libraries</span> <img src="img/preliminary.gif"
              alt="Preliminary" style="width: 300px; height: 80px;" /> </a></h1>
        <p class="heading-quote"> <q>...one of the most highly regarded and
            expertly designed C++ library projects in the world.</q> <span class="heading-attribution">—
            <a class="external" href="http://www.gotw.ca/">Herb Sutter</a> and <a
              class="external" href="http://en.wikipedia.org/wiki/Andrei_Alexandrescu">Andrei
              Alexandrescu</a>, <a class="external" href="http://safari.awprofessional.com/?XmlId=0321113586">C++
              Coding Standards</a></span></p>
      </div>
    </div>
    <div class="clear"> </div>
    <div class="cuerpo_central"> <br />
      <div class="cuerpo_texto"> <br />
        <span style="font-size: 24pt;"> <span style="font-weight: bold; color: black;">
            <a href="index.html">The [ Counter Tree + Suballocator ] Library</a>
          </span></span><br />
        <div>
          <div class="author">
            <h3 class="author"><br />
              <span class="firstname"></span></h3>
            <h3 class="author" style="font-size: 10pt; font-style: italic; font-weight: bold">
              <span style="font-weight: bold;"><span style="font-weight: bold;"
                  class="firstname">Francisco Jose Tapia</span>   Copyright ©
                2010-2013 Francisco Jose Tapia</span></h3>
          </div>
        </div>
        <div class="legalnotice">
          <p><span style="font-size: 10pt; font-style: italic; font-weight: bold">Distributed
              under the Boost Software License, Version 1.0. (See accompanying
              file LICENSE_1_0.txt or copy at <a target="_top" href="file:///LICENSE_1_0.txt">
                http://www.boost.org/LICENSE_1_0.txt )</a></span> </p>
        </div>
        <br />
        <br />
        <br />
        <br />
        <div class="caja_menu"> <span style="font-size: 16pt; color: black;"><br />
            Table of Contents</span> <br />
          <div style="margin-left: 40px;">
            <div style="margin-left: 40px;"> <a href="P1.0_introduction.html#introduction">1.-
                Introduction</a><br />
              <div style="margin-left: 40px;"><a href="P1.0_introduction.html#countertree">1.1.-
                  Description of the Counter Trees</a><br />
                <a href="P1.0_introduction.html#benchmark">1.2.- Benchmark of
                  parallel algorithms</a><br />
                <a href="P1.3.0_new_elements.html#new_elements">1.3.- New
                  elements of the library</a><br />
                <div style="margin-left: 40px;"><a href="P1.3.0_new_elements.html#position">1.3.1.-
                    Access by position and random access iterators </a> <br />
                  <a href="P1.3.0_new_elements.html#deletion">1.3.2.- Deletion
                    in the first/last position</a><br />
                </div>
                <div style="margin-left: 40px;"><a href="P1.3.0_new_elements.html#iterators">1.3.3.-
                    Iterators</a></div>
                <div style="margin-left: 40px;"> <a href="P1.3.4_description_suballocators.html#suballocator">1.3.4.-
                    Memory Problems (Suballocators<span style="color: #0000a0;">)</span></a><br />
                  <a href="P1.3.4_description_suballocators.html#countertree_suballocator">1.3.5.-
                    Description of Counter Trees + Suballocators </a><br />
                  <a href="P1.3.6_lock_system.html#lock">1.3.6.- New Lock system
                    (Single Write Multiple Read Mutex)</a> <br />
                  1<a href="P1.3.6_lock_system.html#new_functions">.3.7.- Safe
                    concurrent programming. (New functions)</a><br />
                </div>
                <a href="P1.4_class_structure.html#class_structure">1.4.- Class
                  structure Code description</a><br />
                <div style="margin-left: 40px;"> <a href="P1.4_class_structure.html#description">1.4.1.-
                    Description of the classes of the library</a><br />
                </div>
                <a href="P1.5.0_future.html#next_improvements">1.5.- Future
                  Improvements</a><br />
                <div style="margin-left: 40px;"><a href="P1.5.0_future.html#strategies">1.5.1-
                    Strategies for many core Systems. Parallel algorithms for
                    very large trees</a> <br />
                </div>
                <div style="margin-left: 40px;"><a href="P1.5.0_future.html#redesign">1.5.2-
                    Redesign of the internal algorithm</a><br />
                  <a href="P1.5.0_future.html#augmented">1.5.3- Augmented trees</a></div>
                <br />
                <br />
              </div>
            </div>
          </div>
        </div>
        <br />
        <br />
        <br />
        <p class="cuerpo_texto"> <br />
        </p>
        <p class="cuerpo_texto"><a name="lock"></a> <span style="font-size: 18pt;font-weight: bold; color: black;">1.3.6.-
            New Lock System ( Single Write Multiple Read Mutex)</span> </p>
        <p class="cuerpo_texto"><br />
        </p>
        <p class="cuerpo_texto">Over a data structure we can do two kind of
          operations :<br />
        </p>
        <ul style="margin-left: 40px;">
          <li> Read operations , or operations that don't modify the data
            structure</li>
          <li>Write operations , or operations that modify the data structure.</li>
        </ul>
        <p class="cuerpo_texto"> <br />
          In a concurrent data structure, several threads can done read
          operations simultaneously , but only one can do a write operation, and
          the others must wait until finish.<br />
          <br />
          In many write operations, by example , delete a node in a map from a
          key, we can see two parts :<br />
        </p>
        <ul style="margin-left: 40px;">
          <li> 1) Look for the node from the key</li>
          <li> 2) Delete the node found in the point 1</li>
        </ul>
        <p class="cuerpo_texto"> <br />
          In many operations the point 1 spend more time than the point 2. It
          would be safe permit read operations simultaneously with the point 1
          of the write operation, and begin with the point 2 only when have an
          exclusive lock of the data structure. This minimize the lock
          contentions, permitting to increase the number of concurrent
          operations over the same data structure.<br />
          <br />
          With the mutex provided by C++11, it is not possible to build a lock
          system for to do this.  Due this the library have a new mutex ( Single
          Write Multiple Read Mutex), designed and created for this library.<br />
          <br />
          This new mutex permit do all the described before in a easy and fast
          way. A detailed description of this mutex is in the pdf document</p>
        <p class="cuerpo_texto"><br />
        </p>
        <img src="img/diagram2.jpg" alt="mutex" />
        <p class="cuerpo_texto"><br />
        </p>
        <p class="cuerpo_texto">The idea is to have the lock data and lock
          functions inside the class. With the actual design the users can make
          programs without knowledge about locks. </p>
        <p class="cuerpo_texto"><br />
        </p>
        <p class="cuerpo_texto">You can find a detailed description of the lock
          method in the point <a target="_blank" title="5.4.- Description of the single writer multiple reader mutex (pdf)"
            href="file:///home/paco/Code/cntree/V2.0/cntree/doc/web/single_writer_multiple_readers_mutex.pdf">5.-4-Description
            of the single write multiple read mutex. <br />
          </a></p>
        <p class="cuerpo_texto"><br />
        </p>
        <p class="cuerpo_texto"> </p>
        <br />
        <br />
        <a name="new_functions"></a> <span style="font-size: 18pt;font-weight: bold; color: black;">1.3.7.-
          Safe concurrent programming. New functions of the classes</span> <br />
        <p class="cuerpo_texto"><br />
        </p>
        <p class="cuerpo_texto">When only 1 thread don't have conflict in the
          access to a resource or data structure. When you have several threads
          the conflicts  associates to the concurrency can appear, because some
          operations need exclusive access . The tools for to prevent the
          conflicts are the locks. </p>
        <p class="cuerpo_texto"><br />
        </p>
        <p class="cuerpo_texto">A lock is like a door in a point of the program.
          If the door is not locked the thread can cross this point. If it is
          locked must wait until unlocked. These locks can be explicit or
          implicit. The explicit are managed by the user, he lock and unlock
          explicitly it. The implicit are included in the code of the function,
          and when you invoke it , the locks are managed internally, but the
          user don't do anything with them.</p>
        <p class="cuerpo_texto"><br />
        </p>
        <p class="cuerpo_texto">With the explicit locks, the user must know the
          use of the locks and understand perfectly the use and implications of
          the locks in order to prevent bad locked resources and threads
          mutually locked (deadlock).</p>
        <p class="cuerpo_texto"><br />
        </p>
        <p class="cuerpo_texto">With the implicit locks, the user don't need to
          know the use of the locks because they are managed internally by the
          functions. The programming of concurrent data structures is easy
          because you don't need take care about the locks. The countertree
          library use implicit locks.</p>
        <p class="cuerpo_texto"><br />
        </p>
        <p class="cuerpo_texto">Some complex problems can't be fully  managed
          with the implicit locks and must use the locks explicitly. If you need
          this, you will find a description in the next point 1.1.4..- Detailed
          lock description. If you don't need you can jump it.</p>
        <br />
        In the multicore development, a great percent of the problems are
        associates to a small couple of situations. This point  describe the
        situations, the problems associated and the solution implemented for to
        resolve them in a safe and easy way for the final user.<br />
        <br />
        The solution adopted is not the only one, and perhaps not the best. It
        is only, the best I had found. My aspiration is to start a discussion
        about the problems in order to find the best solutions. But while
        appear, provide to the community of programmers a solution for to help
        them while the final solution appear.<br />
        <span style="font-weight: bold;"><br />
        </span>Perhaps the best way for to explain this is to show you a problem
        describing situations ans the problem associated.<br />
        <br />
        <span style="font-weight: bold;">SITUATION 1</span> <br />
        You are using a set of elements ( S) . Several cores process the
        elements of the set, always try to process the first element of the set
        , if it is not empty. The process done for the thread is<br />
        <br />
        <div class="caja_codigo">
          <pre><code><span class="style2"><br /><span style="font-weight: bold;">THREAD T1                            THREAD T2  </span></span></code><code><span
class="style2"><br />
while ( S.size() == 0 ) ;            .<br />It = S.begin() ;                     </span></code><code><span
class="style2"><code><span class="style2">while ( S.size() == 0 )</span></code><code><span
class="style2"> ;<br /></span></code>Elem = *It ;</span></code>                         <code><span
class="style2"><code><span class="style2">It = S.begin() ;<br /></span></code></span></code><code><span
class="style2">S.erase (It);</span></code>                        <code><span class="style2">Elem = *It ;<br /></span></code>                                     <code><span
class="style2">S.erase (It);</span></code><code><span class="style10"></span></code></pre>
        </div>
        <br />
        <br />
        <ul style="margin-left: 40px;">
          <li> When the set S have only one element, the thread T1 beginning
            this process, and the thread T2 begin the same code a byte later. </li>
          <li>T2 check the size of S is not zero and obtain the iterator begin (
            ). </li>
          <li>But when try to copy the pointed by the iterator obtained, that
            node is being deleted by T1, perhaps fail , perhaps not.</li>
          <li>But when reach the last line and try to delete the iterator It,
            the element don't exist and the set is empty. The program crash with
            a fault access violation</li>
        </ul>
        <br />
        <br />
        <span style="font-weight: bold;"> SITUATION 2 </span><br />
        Imagine a supermarket. You have registered users, and each one have a
        unique key. You have the information in a map&lt;key, bonus&gt; named M.
        The first value is the key user and the second is a double value with
        the bonus in money obtained by a bunch of concepts.<br />
        <br />
        <div style="margin-left: 40px;">
          <ul>
            <li>You have a thread T1, calculating and modifying the new bonus of
              each user.</li>
            <li>You have other thread T2 which are responsible of the insertion
              and deletion of users.</li>
            <li>The thread T1 looks for a key (K1) and obtain an iterator (
              It1). With the iterator calculate the new bonus and with the
              iterator access to the element and modify the second value.</li>
            <li>The thread T1 have the iterator It1 of the key K1, but while is
              calculating the new bonus, the thread T2, delete that key. When T1
              try to access to the pair &lt;key, bonus&gt; you have an fault
              access violation. The program crash.</li>
          </ul>
        </div>
        <br />
        <br />
        <div class="caja_codigo">
          <pre><code><span class="style2"><br /><span style="font-weight: bold;">THREAD T1                                    THREAD T2  </span></span></code><code><span
class="style2"><br />
It = M.find( k1) ;                           </span></code><code><span class="style2"><code><span
class="style2">Alfa = M.find( k1) ;</span></code><br />auto B = CalculateBonus (It-&gt;second) ;       </span></code><code><span
class="style2"><code><span class="style2"></span></code><code><span class="style2">if ( Alfa != M.end()) M.erase ( Alfa ) ;<br /></span></code>It-&gt;second = B ;</span></code>                         <span
style="color: rgb(42, 68, 55);">    .</span><code><span class="style2"><code><span
class="style2"><br /></span></code></span></code><code><span class="style2"></span></code>                                             .<code><span
class="style2"><br /></span></code>                                     <span style="color: rgb(42, 68, 55);">      </span><code><span
class="style10"></span></code></pre>
        </div>
        <br />
        <br />
        <span style="font-weight: bold;">SOLUTION</span><br />
        The idea for to prevent these problems is to <span style="font-weight: bold;">pack
          several elemental instructions inside the exclusive lock</span>.
        Combining these basic operations , appear new group of instructions,
        easy to understand, easy to use and safe.  You can argue me that if
        fail, the system is not well designed. Nobody can prevent the lack of
        logic  in a program, but can prevent the crash of the program.<br />
        <br />
        The exclusive lock, as described before, have two parts. In the first
        part can be concurrent with others operations which use shared locks,
        and started before this operation. In the second part wait until finish
        all the operations with shared lock, and modify the tree.<br />
        <br />
        Many of these functions have the suffix _if, which indicates that the
        operation have a function as parameter ( usually a lambda function),
        which is executed inside the exclusive lock, and if return true the
        operation is done and if false don't do it<br />
        <br />
        <br />
        <div class="caja_codigo">
          <pre><code><span class="style2"><br /> 
</span></code><code><span class="style11">template &lt;class Function&gt; <br />mypair insert_if </span><span
class="style10">( </span><span class="style11">Function &amp;&amp; </span><span
class="style10"> </span><span class="style11">M</span><span class="style10">,  </span><span
class="style5">const </span><span class="style11">value_type</span><span class="style10">&amp; </span><span
class="style11">val </span><span class="style10">)
</span><br /><span class="style10"><br /></span></code></pre>
        </div>
        <br />
        These classes provide a rich set of instructions, the classical of STL
        data structures and others with a function as parameter for to do
        something inside the exclusive lock of the function<br />
        This provide you a safe way for to do the operations. <br />
        <br />
        You can find a list of these functions in the description of each class.
        If you want a detailed description of the functions with the source code
        <br />
        <div style="margin-left: 40px;">
          <ul>
            <li> <a title="doxygen documentation" href="html/index.html">5.1.-
                doxygen documentation</a></li>
            <li><a title="doxygen files" href="html/files.html">5.2.- source
                code</a></li>
          </ul>
        </div>
        <br />
        <br />
        The next examples shows the two previous described situations and their
        safe codification with the new functions<br />
        <br />
        <span style="font-weight: bold; text-decoration: underline;">SITUATION1
        </span><br />
        <br />
        <div class="caja_codigo">
          <pre><code><span class="style2"><br /><span style="font-weight: bold;">THREAD T1                            THREAD T2  </span></span></code><code><span
class="style2"><br />
while ( S.size() == 0 ) ;            .<br />It = S.begin() ;                     </span></code><code><span
class="style2"><code><span class="style2">while ( S.size() == 0 )</span></code><code><span
class="style2"> ;<br /></span></code>Elem = *It ;</span></code>                         <code><span
class="style2"><code><span class="style2">It = S.begin() ;<br /></span></code></span></code><code><span
class="style2">S.erase (It);</span></code>                        <code><span class="style2">Elem = *It ;<br /></span></code>                                     <code><span
class="style2">S.erase (It);</span></code><code><span class="style10"></span></code></pre>
        </div>
        <br />
        With the new functions<br />
        <br />
        <div class="caja_codigo">
          <pre><code><span class="style2"><br /><span style="font-weight: bold;">THREAD T1                                         THREAD T2  </span></span></code><code><span
class="style2"><br /><br />uint32_t code=S.pop_copy_front ( Elem);           </span></code><code><span
class="style2">uint32_t code=S.pop_copy_front ( Elem);</span></code><code><span
class="style2"><code><span class="style2"></span></code>
</span></code>                        <code><span class="style2"></span></code><code><span
class="style10"></span></code></pre>
        </div>
        <br />
        It's safe and robust<br />
        <br />
        <span style="font-weight: bold; text-decoration: underline;">SITUATION 2</span><br />
        <br />
        <div class="caja_codigo">
          <pre><code><span class="style2"><br /><span style="font-weight: bold;">THREAD T1                                    THREAD T2  </span></span></code><code><span
class="style2"><br />
It = M.find( k1) ;                           </span></code><code><span class="style2"><code><span
class="style2">Alfa = M.find( k1) ;</span></code><br />auto B = CalculateBonus (It-&gt;second) ;       </span></code><code><span
class="style2"><code><span class="style2"></span></code><code><span class="style2">if ( Alfa != M.end()) M.erase ( Alfa ) ;<br /></span></code>It-&gt;second = B ;</span></code>                         <span
style="color: rgb(42, 68, 55);">    .</span><code><span class="style2"><code><span
class="style2"><br /></span></code></span></code><code><span class="style2"></span></code>                                             .<code><span
class="style2"><br /></span></code>                                     <span style="color: rgb(42, 68, 55);">      </span><code><span
class="style10"></span></code></pre>
        </div>
        <br />
        With the new functions<br />
        <br />
        <div class="caja_codigo">
          <pre><code><span class="style2"><br />typedef countertree::map_cnc &lt;user_t, double&gt; MapBonus;<br />typedef MapBonus::value_type MB_vt;<br /><br />MapBonus M ;<br /><br /><span
style="font-weight: bold;">THREAD T1                                                           THREAD T2  </span></span></code><code><span
class="style2"><br />
M.modify(k1,[](MB_vt &amp;A){A.second= CalculateBonus( A.second);});     M.erase (k1)<br /></span></code><span
style="color: rgb(42, 68, 55);"></span><code><span class="style2"><br /></span></code>                                     <span
style="color: rgb(42, 68, 55);">      </span><code><span class="style10"></span></code></pre>
        </div>
        <br />
        Simple, thread safe and robust<br />
      </div>
      <a style="float:right" href="P1.4_class_structure.html#class_structure" title="next_improvements"><img
          src="img/next.png" alt="link to next page" /></a> <a style="float:right"
        href="P1.0_introduction.html" title="introduction"><img src="img/up.png"
          alt="go to head of the page" /></a> <a style="float:right" href="P1.3.4_description_suballocators.html#suballocator"
        title="suballocators"><img alt="previous page" src="img/prev.png" /></a>
      <a style="float:right" href="index.html" title="index.html"><img alt="home page"
          src="img/home.png" /></a> <br />
       
      <table width="100%" xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision">
        <tbody>
          <tr>
            <td align="left">
              <p><small>Last revised: September  30, 2012 at 21:42:41 GMT</small></p>
            </td>
            <td align="right"> <br />
            </td>
          </tr>
        </tbody>
      </table>
      <hr />
      <div id="footer">
        <div id="footer-left">
          <div id="copyright">
            <p>Copyright Francisco Jose Tapia 2010-2012.</p>
          </div>
          <div id="license">
            <p>Distributed under the <a class="internal" href="/LICENSE_1_0.txt">Boost
                Software License, Version 1.0</a>.</p>
          </div>
        </div>
        <div id="footer-right">
          <div id="banners">
            <p id="banner-xhtml"> <a class="external" href="http://validator.w3.org/check?uri=referer">XHTML
                1.0</a></p>
            <p id="banner-css"> <a class="external" href="http://jigsaw.w3.org/css-validator/check/referer">CSS</a></p>
            <p id="banner-osi"> <a class="external" href="http://www.opensource.org/docs/definition.php">OSI
                Certified</a></p>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
